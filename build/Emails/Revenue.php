<?php

/**
 * Revenue generated by emails class.
 *
 * @since   2.2.0
 * @package Noptin
 */

namespace Hizzle\Noptin\Emails;

defined( 'ABSPATH' ) || exit;

/**
 * Revenue generated by emails class.
 */
class Revenue {

	public static function init() {
		// Track email clicks when users log in.
		add_action( 'wp_login', array( __CLASS__, 'track_email_click_on_login' ), 10, 2 );

		// Track email clicks when users are created.
		add_action( 'user_register', array( __CLASS__, 'track_email_click_on_register' ) );
	}

	/**
	 * Logs email clicks
	 *
	 */
	public static function record_email_click( $campaign_id ) {

		// Add cookie.
		if ( ! headers_sent() && ! apply_filters( 'noptin_disable_cookies', false ) ) {
			$duration = apply_filters( 'noptin_click_cookie_duration', MONTH_IN_SECONDS );
			setcookie( 'noptin_cid', noptin_encrypt( $campaign_id ), time() + $duration, COOKIEPATH, COOKIE_DOMAIN );
		}

		// If logged in, record the click.
		if ( get_current_user_id() ) {
			update_user_meta( get_current_user_id(), 'last_noptin_email_clicked', $campaign_id );
		}

		if ( ! empty( $GLOBALS['current_noptin_email'] ) ) {
			self::save_by_email_address( $GLOBALS['current_noptin_email'], $campaign_id );
		}
	}

	public static function save_by_email_address( $email_address, $campaign_id = null ) {
		if ( is_null( $campaign_id ) ) {
			if ( isset( $_COOKIE['noptin_cid'] ) ) {
				$campaign_id = noptin_decrypt( $_COOKIE['noptin_cid'] );
			}

			if ( empty( $campaign_id ) ) {
				$campaign_id = self::get_by_email_address( $email_address );
			}
		}

		if ( empty( $campaign_id ) || ! is_numeric( $campaign_id ) ) {
			return;
		}

		$user  = get_user_by( 'email', $email_address );
		$saved = false;
		if ( $user ) {
			update_user_meta( $user->ID, 'last_noptin_email_clicked', $campaign_id );
			$saved = true;
		}

		$subscriber = noptin_get_subscriber( $email_address );
		if ( $subscriber->exists() ) {
			update_noptin_subscriber_meta( $subscriber->get_id(), 'last_noptin_email_clicked', $campaign_id );
			$saved = true;
		}

		$transient_key = 'noptin_email_click_' . md5( $email_address );
		if ( ! $saved ) {
			// Store in transients for non-registered users.
			set_transient( $transient_key, $campaign_id, DAY_IN_SECONDS );
		} else {
			delete_transient( $transient_key );
		}
	}

	private static function get_by_email_address( $email_address ) {
		$user = get_user_by( 'email', $email_address );
		if ( $user ) {
			$campaign_id = get_user_meta( $user->ID, 'last_noptin_email_clicked', true );
			if ( is_numeric( $campaign_id ) ) {
				return $campaign_id;
			}
		}

		$subscriber = noptin_get_subscriber( $email_address );
		if ( $subscriber->exists() ) {
			$campaign_id = get_noptin_subscriber_meta( $subscriber->get_id(), 'last_noptin_email_clicked', true );
			if ( is_numeric( $campaign_id ) ) {
				return $campaign_id;
			}
		}

		$transient_key = 'noptin_email_click_' . md5( $email_address );
		$campaign_id   = get_transient( $transient_key );
		if ( is_numeric( $campaign_id ) ) {
			return $campaign_id;
		}

		return '';
	}

	public static function track_email_click_on_login( $user_login, $user ) {
		if ( $user ) {
			self::save_by_email_address( $user->user_email );
		}
	}

	public static function track_email_click_on_register( $user_id ) {
		self::track_email_click_on_login( '', get_user_by( 'id', $user_id ) );
	}

	public static function get_referring_email_id() {
		if ( get_current_user_id() ) {
			$user = get_user_by( 'id', get_current_user_id() );
			if ( $user ) {
				$campaign_id = self::get_by_email_address( $user->user_email );
				if ( is_numeric( $campaign_id ) ) {
					return (int) $campaign_id;
				}
			}
		}

		if ( ! empty( $GLOBALS['current_noptin_email'] ) ) {
			$campaign_id = self::get_by_email_address( $GLOBALS['current_noptin_email'] );
			if ( is_numeric( $campaign_id ) ) {
				return (int) $campaign_id;
			}
		}

		if ( isset( $_COOKIE['noptin_cid'] ) ) {
			$cid = noptin_decrypt( $_COOKIE['noptin_cid'] );

			if ( is_numeric( $cid ) ) {
				return (int) $cid;
			}
		}

		return 0;
	}

	public static function attribute_sale( $amount, $campaign_id = null, $email_address = null ) {
		if ( ! get_noptin_option( 'enable_ecommerce_tracking', true ) ) {
			return;
		}

		if ( is_null( $campaign_id ) ) {
			$campaign_id = self::get_referring_email_id();

			if ( empty( $campaign_id ) && ! empty( $email_address ) ) {
				$campaign_id = self::get_by_email_address( $email_address );
			}

			if ( empty( $campaign_id ) && isset( $_COOKIE['noptin_cid'] ) ) {
				$campaign_id = noptin_decrypt( $_COOKIE['noptin_cid'] );
			}
		}

		if ( ! empty( $campaign_id ) ) {
			increment_noptin_campaign_stat( $campaign_id, '_revenue', $amount );

			if ( ! empty( $email_address ) ) {
				$callback  = apply_filters( 'noptin_format_price_callback', '', $amount );
				$formatted = empty( $callback ) ? $amount : call_user_func( $callback, $amount );

				Logs\Main::create(
					'purchase',
					$campaign_id,
					$email_address,
					wp_strip_all_tags( $formatted )
				);
			}
		}

		// Remove the cookie after attributing the sale.
		if ( isset( $_COOKIE['noptin_cid'] ) ) {
			setcookie( 'noptin_cid', '', time() - 3600, COOKIEPATH, COOKIE_DOMAIN );
			unset( $_COOKIE['noptin_cid'] );
		}

		if ( ! empty( $email_address ) ) {
			delete_transient( 'noptin_email_click_' . md5( $email_address ) );
			$user = get_user_by( 'email', $email_address );
			if ( $user ) {
				delete_user_meta( $user->ID, 'last_noptin_email_clicked' );
			}

			$subscriber = noptin_get_subscriber( $email_address );
			if ( $subscriber->exists() ) {
				delete_noptin_subscriber_meta( $subscriber->get_id(), 'last_noptin_email_clicked' );
			}
		}
	}
}
